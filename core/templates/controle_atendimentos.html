{% extends 'base.html' %}
{% load static %}
{% load custom_tags %} 

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h4 class="mb-1"><i class="bi bi-table me-2"></i>Controle de Atendimentos</h4>
        <p class="text-muted small mb-0">Visão mensal consolidada (Grade Fixa e Reposições)</p>
    </div>
    <div class="col-md-6 text-end">
        <form method="get" class="d-flex gap-2 justify-content-end align-items-center">
            {% if is_admin %}
            <select name="terapeuta" class="form-select form-select-sm" style="max-width: 200px;" onchange="this.form.submit()">
                <option value="">Todos Terapeutas</option>
                {% for t in terapeutas %}
                <option value="{{ t.id }}" {% if filtro_terapeuta_selecionado == t.id %}selected{% endif %}>{{ t.nome }}</option>
                {% endfor %}
            </select>
            {% endif %}
            
            <select name="mes" class="form-select form-select-sm" style="width: 130px;" onchange="this.form.submit()">
                {% for num, nome in meses %}
                <option value="{{ num }}" {% if num == mes_atual %}selected{% endif %}>{{ nome }}</option>
                {% endfor %}
            </select>
            
            <select name="ano" class="form-select form-select-sm" style="width: 100px;" onchange="this.form.submit()">
                {% for ano in anos %}
                <option value="{{ ano }}" {% if ano == ano_atual %}selected{% endif %}>{{ ano }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header border-bottom-0 pb-0">
        <ul class="nav nav-tabs card-header-tabs" id="controleTab" role="tablist">
            {# ABAS DOS DIAS DA SEMANA #}
            {% for dia in relatorio_semanal %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if forloop.first %}active{% endif %}" 
                        id="tab-{{ forloop.counter0 }}" 
                        data-bs-toggle="tab" 
                        data-bs-target="#content-{{ forloop.counter0 }}" 
                        type="button" 
                        role="tab">
                    {{ dia.nome_dia }}
                </button>
            </li>
            {% endfor %}
            
            {# NOVA ABA: REPOSIÇÕES #}
            <li class="nav-item" role="presentation">
                <button class="nav-link text-warning fw-bold" 
                        id="tab-reposicoes" 
                        data-bs-toggle="tab" 
                        data-bs-target="#content-reposicoes" 
                        type="button" 
                        role="tab">
                    <i class="bi bi-arrow-repeat me-1"></i>Reposições
                </button>
            </li>
        </ul>
    </div>
    
    <div class="card-body p-0">
        <div class="tab-content" id="controleTabContent">
            
            {# CONTEUDO DOS DIAS #}
            {% for dia in relatorio_semanal %}
            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="content-{{ forloop.counter0 }}" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0 align-middle text-center" style="font-size: 0.85rem;">
                        <thead class="table-light">
                            <tr>
                                <th class="text-start ps-3" style="min-width: 200px;">Paciente (Grade Fixa)</th>
                                <th style="width: 100px;">Terapeuta</th>
                                <th style="width: 80px;">Horário</th>
                                {% for data in dia.datas %}
                                <th style="width: 90px;">{{ data|date:"d/m" }}</th>
                                {% endfor %}
                                <th class="bg-light border-start border-3" style="width: 50px;" title="Presenças">P</th>
                                <th class="bg-light" style="width: 50px;" title="Faltas">F</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for linha in dia.linhas %}
                            <tr>
                                <td class="text-start ps-3 fw-medium text-dark">{{ linha.paciente_nome }}</td>
                                <td class="text-muted small">{{ linha.terapeuta_nome }}</td>
                                <td class="text-muted small">{{ linha.hora|date:"H:i" }}</td>
                                
                                {% for data in dia.datas %}
                                    {% with status=linha.status_por_data|get_item:data %}
                                    <td class="
                                        {% if status == 'P' %}text-success fw-bold bg-success-subtle
                                        {% elif status == 'F' %}text-danger fw-bold bg-danger-subtle
                                        {% else %}text-muted{% endif %}
                                    ">
                                        {{ status|default:"-" }}
                                    </td>
                                    {% endwith %}
                                {% endfor %}
                                
                                <td class="fw-bold text-success border-start border-3">{{ linha.total_p }}</td>
                                <td class="fw-bold text-danger">{{ linha.total_f }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{{ dia.datas|length|add:5 }}" class="py-5 text-muted">
                                    <i class="bi bi-calendar-x d-block mb-2 fs-4"></i>
                                    Nenhuma agenda fixa neste dia.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}

            {# CONTEUDO DA ABA REPOSIÇÕES #}
            <div class="tab-pane fade" id="content-reposicoes" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped mb-0 align-middle" style="font-size: 0.9rem;">
                        <thead class="table-warning">
                            <tr>
                                <th class="ps-4">Paciente</th>
                                <th>Terapeuta</th>
                                <th class="text-center">Data Realizada</th>
                                <th class="text-center">Dia da Semana</th>
                                <th class="text-center">Qtd. Sessões</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in lista_reposicoes %}
                            <tr>
                                <td class="ps-4 fw-medium">{{ item.paciente_nome }}</td>
                                <td>{{ item.terapeuta_nome }}</td>
                                <td class="text-center">{{ item.data|date:"d/m/Y" }}</td>
                                <td class="text-center text-muted small">{{ item.data|date:"l" }}</td>
                                <td class="text-center fw-bold">{{ item.qtd_sessoes }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="bi bi-check-circle d-block mb-2 fs-4"></i>
                                    Nenhuma reposição (agendamento avulso) registrada neste mês.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="4" class="text-end fw-bold pe-3">TOTAL DE REPOSIÇÕES NO MÊS:</td>
                                <td class="text-center fw-bold fs-6 text-dark bg-warning-subtle">{{ total_reposicoes_mes }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}