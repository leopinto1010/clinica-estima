{% extends 'base.html' %}
{% load custom_tags %}

{% block content %}

<style>
    /* Estilo de grade similar à ocupação de salas */
    .evento-sala {
        font-size: 0.75rem;
        padding: 6px;
        margin-bottom: 3px;
        border-radius: 6px;
        border-left: 4px solid;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: transform 0.1s;
        cursor: pointer;
        background-color: #f8f9fa; /* Cor neutra padrão se não tiver status */
    }
    .evento-sala:hover { transform: scale(1.02); z-index: 10; position: relative; }
    
    /* CORES POR STATUS */
    .status-AGUARDANDO { 
        border-left-color: #0d6efd !important; 
        background-color: #e7f1ff !important; 
        color: #004085 !important; 
    }
    .status-REALIZADO { 
        border-left-color: #198754 !important; 
        background-color: #d1e7dd !important; 
        color: #0f5132 !important; 
    }
    .status-FALTA { 
        border-left-color: #dc3545 !important; 
        background-color: #f8d7da !important; 
        color: #842029 !important; 
    }

    /* Navegação Centralizada */
    .nav-date-container {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        padding: 4px;
        min-width: 320px;
    }
    .btn-nav-date {
        border: none; background: transparent; color: #6c757d;
        padding: 5px 0;
        width: 40px;
        text-align: center;
        border-radius: 4px; transition: all 0.2s;
        flex-shrink: 0;
    }
    .btn-nav-date:hover { background: #f8f9fa; color: #0d6efd; }
    
    .nav-center-text {
        flex-grow: 1;
        text-align: center;
        padding: 0 10px;
    }

    .col-hora-icon {
        width: 70px;
        text-align: center;
        vertical-align: middle !important;
        background-color: #f8f9fa;
        color: #6c757d;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold text-dark mb-1">Agenda Operacional</h4>
        <p class="text-muted small mb-0">Gerencie presenças, faltas e evoluções.</p>
    </div>
    
    {% if is_admin %}
    <div>
        <button type="button" class="btn btn-outline-danger shadow-sm border-0 bg-white" data-bs-toggle="modal" data-bs-target="#modalLimparDia">
            <i class="bi bi-trash me-1"></i> Limpar Dia
        </button>
    </div>
    {% endif %}
</div>

<div id="modalLimparDia" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white border-0">
        <h5 class="modal-title fs-6"><i class="bi bi-exclamation-triangle-fill me-2"></i>Limpar Agenda</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center p-4">
        <p class="mb-3">Isso apagará <strong>todos</strong> os agendamentos não realizados do dia selecionado.</p>
        <form action="{% url 'limpar_dia' %}" method="POST">
            {% csrf_token %}
            <div class="mb-3 text-start">
                <label class="form-label small fw-bold">Selecione o dia:</label>
                <input type="date" name="data_para_limpar" class="form-control" required min="{{ agora|date:'Y-m-d' }}">
            </div>
            <button type="submit" class="btn btn-danger w-100 rounded-pill" onclick="return confirm('Confirmar exclusão em massa?')">Apagar Tudo</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="modalDetalhes" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-3">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold text-dark">Detalhes do Agendamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-2 px-4">
        <div class="d-flex align-items-center mb-4 mt-2 p-3 bg-light rounded-3">
            <div class="bg-white rounded-circle p-3 me-3 text-secondary shadow-sm">
                <i class="bi bi-person-fill fs-3"></i>
            </div>
            <div>
                <h5 class="mb-0 fw-bold text-dark" id="detalhePaciente">Nome do Paciente</h5>
                <span class="badge bg-primary-subtle text-primary border border-primary-subtle mt-1" id="detalheModalidade">Modalidade</span>
                <span class="badge bg-secondary-subtle text-secondary mt-1 border" id="detalheSalaBadge">Sem Sala</span>
            </div>
        </div>
        <div class="row g-3 mb-3">
            <div class="col-6"><label class="small text-muted fw-bold text-uppercase d-block mb-1">Data/Hora</label><div id="detalheData" class="fw-medium text-dark bg-white border rounded p-2 text-center small"></div></div>
            <div class="col-6"><label class="small text-muted fw-bold text-uppercase d-block mb-1">Status</label><div id="detalheStatus" class="fw-medium text-dark bg-white border rounded p-2 text-center small"></div></div>
            <div class="col-12"><label class="small text-muted fw-bold text-uppercase d-block mb-1">Terapeuta</label><div id="detalheTerapeuta" class="fw-medium text-dark bg-white border rounded p-2"></div></div>
            {% if is_admin %}
            <div class="col-12"><label class="small text-muted fw-bold text-uppercase d-block mb-1">Tipo de Pagamento</label><div id="detalheTipo" class="fw-medium text-secondary"></div></div>
            {% endif %}
        </div>
      </div>
      <div class="modal-footer border-top-0 bg-light rounded-bottom justify-content-between px-4 pb-4">
          <div id="detalheAcoesPrincipais" class="d-flex gap-2 w-100"></div>
          <div id="detalheAcaoExcluir" class="ps-2"></div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0 fw-bold text-dark"><i class="bi bi-funnel-fill me-2"></i>Filtros e Navegação</h6>
    </div>
    <div class="card-body bg-light">
        <form method="GET" id="formFiltro" class="row g-3">
            <input type="hidden" name="data_inicio" id="dataInicio" value="{{ data_inicio }}">
            <input type="hidden" name="data_fim" id="dataFim" value="{{ data_fim }}">

            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">Paciente</label>
                <select name="filtro_paciente" class="form-select campo-busca">
                    <option value="">Buscar Paciente...</option>
                    {% for p in pacientes %}
                        <option value="{{ p.id }}" {% if p.id == filtro_paciente_selecionado %}selected{% endif %}>{{ p.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            
            {% if is_admin %}
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted">Terapeuta</label>
                <select name="filtro_terapeuta" class="form-select campo-busca">
                    <option value="">Selecione...</option>
                    <option value="todos" {% if filtro_terapeuta_selecionado == 'todos' %}selected{% endif %}>Ver Todos</option>
                    {% for t in terapeutas %}
                        <option value="{{ t.id }}" {% if t.id|stringformat:"s" == filtro_terapeuta_selecionado %}selected{% endif %}>{{ t.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted">Status</label>
                <select name="filtro_status" class="form-select">
                    <option value="">Todos</option>
                    {% for codigo, label in status_choices %}
                        <option value="{{ codigo }}" {% if codigo == filtro_status_selecionado %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i> Filtrar</button>
            </div>
            
            <div class="col-md-2 align-self-end text-end">
                {% if is_admin %}
                <a href="{% url 'novo_agendamento' %}" class="btn btn-success shadow-sm w-100 text-nowrap">
                    <i class="bi bi-plus-lg"></i> Marcar Agendamento Avulso
                </a>
                {% endif %}
            </div>
            
            <div class="col-12 mt-4 border-top pt-3 text-center">
                 <div class="nav-date-container shadow-sm">
                    <button type="button" class="btn-nav-date" onclick="navegarSemana('anterior')" title="Anterior">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    
                    <div class="nav-center-text d-flex flex-column justify-content-center" style="cursor: pointer;" onclick="document.getElementById('pickerData').showPicker()">
                        <small class="d-block text-muted fw-bold text-uppercase" style="font-size: 0.65rem; letter-spacing: 1px;">Intervalo</small>
                        <span class="fw-bold text-dark text-nowrap">
                            {{ dates_in_range|first|date:"d/m/Y" }} <span class="text-muted mx-1">até</span> {{ dates_in_range|last|date:"d/m/Y" }}
                        </span>
                        <input type="date" id="pickerData" 
                               style="position: absolute; opacity: 0; width: 1px; height: 1px; bottom: 0; left: 50%;" 
                               onchange="navegarSemana(this.value)">
                    </div>

                    <button type="button" class="btn-nav-date" onclick="navegarSemana('proxima')" title="Próxima">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card border-0 shadow-sm mb-5">
    <div class="table-responsive">
        <table class="table table-bordered text-center mb-0 align-middle" style="table-layout: fixed; min-width: 1000px;">
            <thead class="bg-light">
                <tr>
                    <th class="col-hora-icon"><i class="bi bi-clock"></i></th>
                    
                    {% for data in dates_in_range %}
                        <th class="text-secondary small text-uppercase {% if data == agora.date %}bg-primary bg-opacity-10{% endif %}">
                            {{ data|date:"l" }} <br>
                            <span class="text-dark fw-bold">{{ data|date:"d/m" }}</span>
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for hora in horarios_grade %}
                <tr>
                    <td class="fw-bold text-muted small bg-light">{{ hora|date:"H:i" }}</td>
                    
                    {% for data in dates_in_range %}
                        <td class="p-1 align-top text-start position-relative" style="height: 60px; background-color: #fff;">
                            
                            {% with chave_hora=hora|date:"H:i" %}
                            {% with chave_data=data|date:"Y-m-d" %}
                            {% with lista=agenda_map|dict_get:chave_hora|dict_get:chave_data %}
                                {% for item in lista %}
                                    <div class="evento-sala status-{{ item.status }}" 
                                         onclick="abrirDetalhes(
                                            '{{ item.paciente.nome|escapejs }}',
                                            '{{ item.sala.nome|default:'-'|escapejs }}',
                                            '{{ item.terapeuta.nome|escapejs }}',
                                            '{{ item.get_tipo_atendimento_display|escapejs }}',
                                            '{{ item.data|date:'d/m/Y' }} • {{ item.hora_inicio|date:'H:i' }}',
                                            '{{ item.get_status_display }}',
                                            '{{ item.status }}',
                                            '{% url 'realizar_consulta' item.id %}',
                                            '{% url 'marcar_falta' item.id %}',
                                            '{% url 'reposicao_agendamento' item.id %}',
                                            '{% url 'excluir_agendamento' item.id %}',
                                            {{ item.agenda_fixa|yesno:'true,false' }},
                                            '{{ item.descricao_modalidade|escapejs }}' 
                                         )"
                                         title="Terapeuta: {{ item.terapeuta.nome }}">
                                        
                                        <div class="fw-bold text-truncate" style="font-size: 0.8rem;">
                                            {{ item.paciente.nome }}
                                        </div>

                                        <div class="text-primary fw-bold text-truncate" style="font-size: 0.7rem; letter-spacing: -0.3px;">
                                            {{ item.descricao_modalidade }}
                                        </div>

                                        <div class="d-flex justify-content-between text-muted border-top border-secondary border-opacity-10 pt-1 mt-1">
                                            <span style="font-size: 0.65rem; color: inherit;">
                                                {% if is_admin %}
                                                    {{ item.terapeuta.nome|slice:":10" }}...
                                                {% else %}
                                                    {{ item.sala.nome|default:"-" }}
                                                {% endif %}
                                            </span>
                                            
                                            {% if item.agenda_fixa %}
                                                <i class="bi bi-arrow-repeat opacity-50" style="font-size: 0.7rem;" title="Fixo"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}

                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    var IS_ADMIN = {{ is_admin|yesno:"true,false" }};
    var paramsUrl = "{{ request.GET.urlencode }}";

    function navegarSemana(acao) {
        var dtInicio = new Date(document.getElementById('dataInicio').value);
        
        if (acao === 'anterior') {
            dtInicio.setDate(dtInicio.getDate() - 7);
        } else if (acao === 'proxima') {
            dtInicio.setDate(dtInicio.getDate() + 7);
        } else {
            // Data selecionada no DatePicker
            var selecionada = new Date(acao);
            var day = selecionada.getDay(); 
            // Ajusta para segunda-feira
            var diff = selecionada.getDate() - day + (day == 0 ? -6 : 1); 
            dtInicio = new Date(selecionada.setDate(diff));
        }

        var novoInicio = dtInicio.toISOString().split('T')[0];
        
        var dtFim = new Date(dtInicio);
        dtFim.setDate(dtFim.getDate() + 6);
        var novoFim = dtFim.toISOString().split('T')[0];

        document.getElementById('dataInicio').value = novoInicio;
        document.getElementById('dataFim').value = novoFim;
        
        document.getElementById('formFiltro').submit();
    }

    function abrirDetalhes(paciente, sala, terapeuta, tipo, data_fmt, status_label, status_cod, url_atender, url_falta, url_repor, url_excluir, is_fixo, modalidade_label) {
        $('#detalhePaciente').text(paciente);
        $('#detalheSalaBadge').text(sala);
        $('#detalheTerapeuta').text(terapeuta);
        $('#detalheTipo').text(tipo);
        $('#detalheData').text(data_fmt);
        $('#detalheStatus').text(status_label);
        
        // Exibe a modalidade (que pode ser a especialidade padrão ou Bobath/AT)
        $('#detalheModalidade').text(modalidade_label);

        var htmlBotoes = ''; 
        var htmlLixeira = '';
        var url_reverter = url_excluir.replace('excluir', 'reverter');

        if (paramsUrl) {
            var separator = (url_atender.indexOf('?') === -1) ? '?' : '&';
            url_atender += separator + paramsUrl;
            
            separator = (url_falta.indexOf('?') === -1) ? '?' : '&';
            url_falta += separator + paramsUrl;
            
            separator = (url_repor.indexOf('?') === -1) ? '?' : '&';
            url_repor += separator + paramsUrl;
            
            separator = (url_excluir.indexOf('?') === -1) ? '?' : '&';
            url_excluir += separator + paramsUrl;
            
            separator = (url_reverter.indexOf('?') === -1) ? '?' : '&';
            url_reverter += separator + paramsUrl;
        }

        if (IS_ADMIN && (status_cod === 'AGUARDANDO' || status_cod === 'FALTA') && !is_fixo) { 
             htmlLixeira = `<a href="${url_excluir}" class="btn btn-outline-danger border-0 p-2" onclick="return confirm('ATENÇÃO: Apagar permanentemente?')" title="Excluir"><i class="bi bi-trash fs-5"></i></a>`; 
        }

        if (status_cod === 'AGUARDANDO') { 
            htmlBotoes += `<a href="${url_atender}" class="btn btn-primary flex-grow-1 fw-bold rounded-pill">Atender Paciente</a>`; 
            htmlBotoes += `<a href="${url_falta}" class="btn btn-outline-danger rounded-pill px-4">Falta</a>`; 
        
        } else if (status_cod === 'REALIZADO') { 
            htmlBotoes += `<div class="d-flex gap-2 w-100">`;
            htmlBotoes += `  <a href="${url_atender}" class="btn btn-success flex-grow-1 rounded-pill fw-bold">Ver Prontuário</a>`;
            htmlBotoes += `  <a href="${url_reverter}" class="btn btn-warning text-white rounded-pill px-3" onclick="return confirm('ATENÇÃO: Desfazer este atendimento voltará o status para AGUARDANDO. Confirma?')" title="Desfazer"><i class="bi bi-arrow-counterclockwise"></i></a>`;
            htmlBotoes += `</div>`;
            
        } else if (status_cod === 'FALTA') { 
            htmlBotoes += `<div class="d-flex gap-2 w-100">`;
            htmlBotoes += `  <a href="${url_repor}" class="btn btn-secondary flex-grow-1 rounded-pill fw-bold"><i class="bi bi-arrow-repeat"></i> Repor</a>`; 
            htmlBotoes += `  <a href="${url_reverter}" class="btn btn-warning text-white rounded-pill px-3" onclick="return confirm('ATENÇÃO: Desfazer esta falta voltará o status para AGUARDANDO. Confirma?')" title="Desfazer"><i class="bi bi-arrow-counterclockwise"></i></a>`;
            htmlBotoes += `</div>`;
        }

        $('#detalheAcoesPrincipais').html(htmlBotoes);
        $('#detalheAcaoExcluir').html(htmlLixeira);
        
        var modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
        modal.show();
    }
</script>
{% endblock %}