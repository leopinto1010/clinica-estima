{% extends 'base.html' %}

{% block content %}
<style>
    .filtro-box { 
        background: #fff; 
        padding: 20px; 
        border: 1px solid #ddd; 
        margin-bottom: 25px; 
        border-radius: 8px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
    }
    .filtro-box label { font-weight: 600; font-size: 13px; color: #555; margin-bottom: 5px; }
    
    .label-cancelado { background-color: #777; }    
    .label-falta { background-color: #d9534f; }
    
    input:disabled { background-color: #f5f5f5 !important; cursor: not-allowed; opacity: 0.6; }
</style>

<div class="row">
    <div class="col-md-12">
        <h3 style="margin-top: 0; color: #333;">Histórico Geral de Consultas</h3>
        <p class="text-muted">Utilize os filtros abaixo para localizar atendimentos específicos (inclusive cancelados).</p>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="filtro-box">
            <form method="GET" id="formFiltro">
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Nome do Paciente:</label>
                            <input type="text" name="busca_nome" class="form-control" placeholder="Digite o nome..." value="{{ busca_nome }}">
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Status:</label>
                            <select name="filtro_status" class="form-control">
                                <option value="">Todos</option>
                                {% for codigo, label in status_choices %}
                                    <option value="{{ codigo }}" {% if codigo == filtro_status_selecionado %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    {% if user.is_superuser %}
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Tipo de Atendimento:</label>
                            <select name="filtro_tipo" class="form-control">
                                <option value="">Todos</option>
                                {% for codigo, nome in tipos_atendimento %}
                                    <option value="{{ codigo }}" {% if codigo == filtro_tipo_selecionado %}selected{% endif %}>
                                        {{ nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}

                    {% if is_admin %}
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Terapeuta:</label>
                            <select name="filtro_terapeuta" class="form-control">
                                <option value="">Todos</option>
                                {% for t in terapeutas %}
                                    <option value="{{ t.id }}" {% if t.id == filtro_terapeuta_selecionado %}selected{% endif %}>
                                        {{ t.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="row" style="margin-top: 10px;">
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>De:</label>
                            <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio|default:'' }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Até:</label>
                            <input type="date" name="data_fim" class="form-control" value="{{ data_fim|default:'' }}">
                        </div>
                    </div>

                    <div class="col-md-3" style="padding-top: 25px;">
                         <label class="radio-inline">
                            <input type="radio" name="atalho_data" value="hoje" onclick="aplicarAtalho('hoje')" {% if filtro_hoje %}checked{% endif %}> Hoje
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="atalho_data" value="semana" onclick="aplicarAtalho('semana')" {% if filtro_semana %}checked{% endif %}> Semana
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="atalho_data" value="personalizado" onclick="aplicarAtalho('limpar')" {% if not filtro_hoje and not filtro_semana %}checked{% endif %}> Intervalo
                        </label>
                        
                        <input type="hidden" name="filtro_hoje" id="inputFiltroHoje" value="{% if filtro_hoje %}1{% endif %}">
                        <input type="hidden" name="filtro_semana" id="inputFiltroSemana" value="{% if filtro_semana %}1{% endif %}">
                    </div>

                    <div class="col-md-3" style="padding-top: 23px;">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="glyphicon glyphicon-search"></i> Filtrar Histórico
                        </button>
                    </div>
                    
                    <div class="col-md-2" style="padding-top: 23px;">
                        <a href="{% url 'lista_consultas_geral' %}" class="btn btn-default btn-block">Limpar</a>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading" style="background-color: #fcfcfc;">
                <strong>Lista de Atendimentos</strong>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover" style="margin-bottom: 0;">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Data/Hora</th>
                            <th style="width: 30%;">Paciente</th>
                            
                            {% if is_admin %}
                            <th style="width: 20%;">Terapeuta</th>
                            {% endif %}
                            
                            {% if user.is_superuser %}
                            <th style="width: 15%;">Tipo</th>
                            {% endif %}
                            
                            <th style="width: 15%;">Status</th>
                            <th style="width: 10%;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for agendamento in agendamentos %}
                        <tr>
                            <td>
                                <strong>{{ agendamento.data|date:"d/m/Y" }}</strong><br>
                                <small class="text-muted">
                                    {{ agendamento.hora_inicio|date:"H:i" }} - {{ agendamento.hora_fim|date:"H:i"|default:"..." }}
                                </small>
                            </td>
                            <td><strong>{{ agendamento.paciente.nome }}</strong></td>
                            
                            {% if is_admin %}
                            <td>{{ agendamento.terapeuta.nome }}</td>
                            {% endif %}

                            {% if user.is_superuser %}
                            <td>
                                <span class="label label-default" style="background-color: #a48abd;">
                                    {{ agendamento.get_tipo_atendimento_display }}
                                </span>
                            </td>
                            {% endif %}
                            
                            <td>
                                {% if agendamento.status == 'REALIZADO' %}
                                    <span class="label label-success">Realizado</span>
                                {% elif agendamento.status == 'CANCELADO' %}
                                    <span class="label label-cancelado">Cancelado</span> 
                                {% elif agendamento.status == 'FALTA' %} 
                                    <span class="label label-falta">Falta</span> 
                                {% else %}
                                    <span class="label label-info">Aguardando</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if agendamento.status == 'REALIZADO' %}
                                    <a href="{% url 'realizar_consulta' agendamento.id %}" class="btn btn-xs btn-success">
                                        <i class="glyphicon glyphicon-file"></i> Prontuário
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if is_admin %}6{% else %}5{% endif %}" class="text-center" style="padding: 30px; color: #999;">
                                <i class="glyphicon glyphicon-info-sign" style="font-size: 20px;"></i><br>
                                Nenhum atendimento encontrado para os filtros selecionados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function aplicarAtalho(tipo) {
        document.getElementById('inputFiltroHoje').value = '';
        document.getElementById('inputFiltroSemana').value = '';

        if (tipo === 'hoje') {
            document.getElementById('inputFiltroHoje').value = '1';
            document.getElementById('formFiltro').submit();
        } else if (tipo === 'semana') {
            document.getElementById('inputFiltroSemana').value = '1';
            document.getElementById('formFiltro').submit();
        }
    }
</script>
{% endblock %}