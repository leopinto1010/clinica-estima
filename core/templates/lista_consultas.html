{% extends 'base.html' %}

{% block content %}
<style>
    /* Estilos do Container de Filtros */
    .filtro-box { 
        background: #fff; 
        padding: 20px; 
        border: 1px solid #ddd; 
        margin-bottom: 25px; 
        border-radius: 8px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
    }
    
    /* Alinhamento dos rótulos */
    .filtro-box label {
        font-weight: 600;
        font-size: 13px;
        color: #555;
        margin-bottom: 5px;
    }

    /* Cores de Status */
    .label-confirmado { background-color: #f0ad4e; }
    .label-faltou { background-color: #777; }
    
    /* Select2 e Inputs */
    .select2-container { min-width: 100%; }
    .select2-container--default .select2-selection--single {
        border: 1px solid #ccc !important;
        height: 34px !important;
    }

    /* Feedback visual de campo desativado */
    input:disabled { 
        background-color: #f5f5f5 !important; 
        cursor: not-allowed; 
        opacity: 0.6;
    }

    /* Alinhamento vertical da linha de filtros */
    .flex-row {
        display: flex;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .ou-divider {
        padding-bottom: 7px;
        font-weight: bold;
        color: #999;
    }
</style>

<div class="row">
    <div class="col-md-12">
        <h3 style="margin-top: 0; color: #333;">Histórico Geral de Consultas</h3>
        <p class="text-muted">Utilize os filtros abaixo para localizar atendimentos específicos.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="filtro-box">
            <form method="GET" id="formFiltro">
                <div class="row flex-row">
                    
                    <div class="col-md-3">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Paciente:</label>
                            <select name="paciente" class="form-control campo-busca">
                                <option value="">Todos os Pacientes</option>
                                {% for p in pacientes %}
                                    <option value="{{ p.id }}" {% if p.id == paciente_selecionado %}selected{% endif %}>
                                        {{ p.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Dia Específico:</label>
                            <input type="date" name="data_unica" id="data_unica" class="form-control" value="{{ data_unica }}">
                        </div>
                    </div>

                    <div class="col-md-1 text-center ou-divider">
                        OU
                    </div>

                    <div class="col-md-2">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Início (De):</label>
                            <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio }}">
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Fim (Até):</label>
                            <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim }}">
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="form-group" style="margin-bottom: 0; display: flex; gap: 5px;">
                            <button type="submit" class="btn btn-primary" style="flex: 2;">
                                <i class="glyphicon glyphicon-search"></i> Filtrar
                            </button>
                            <a href="{% url 'lista_consultas_geral' %}" class="btn btn-default" title="Limpar Filtros" style="flex: 1;">
                                <i class="glyphicon glyphicon-erase"></i>
                            </a>
                        </div>
                    </div>

                </div>
            </form>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading" style="background-color: #fcfcfc;">
                <strong>Lista de Atendimentos</strong>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover" style="margin-bottom: 0;">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Data/Hora</th>
                            <th style="width: 40%;">Paciente</th>
                            <th style="width: 20%;">Status</th>
                            <th style="width: 20%;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for agendamento in agendamentos %}
                        <tr>
                            <td>{{ agendamento.data_hora|date:"d/m/Y H:i" }}</td>
                            <td><strong>{{ agendamento.paciente.nome }}</strong></td>
                            <td>
                                {% if agendamento.status == 'REALIZADO' %}
                                    <span class="label label-success">Realizado</span>
                                {% elif agendamento.status == 'CANCELADO' %}
                                    <span class="label label-danger">Cancelado</span>
                                {% elif agendamento.status == 'CONFIRMADO' %}
                                    <span class="label label-confirmado">Confirmado</span>
                                {% elif agendamento.status == 'FALTOU' %}
                                    {% elif agendamento.status == 'FALTA' %} <span class="label label-faltou">Falta</span>
                                {% else %}
                                    <span class="label label-info">Aguardando</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if agendamento.status == 'REALIZADO' %}
                                    <a href="{% url 'realizar_consulta' agendamento.id %}" class="btn btn-xs btn-success">
                                        <i class="glyphicon glyphicon-file"></i> Prontuário
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center" style="padding: 30px; color: #999;">
                                <i class="glyphicon glyphicon-info-sign" style="font-size: 20px;"></i><br>
                                Nenhum atendimento encontrado para os filtros selecionados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputUnico = document.getElementById('data_unica');
        const inputInicio = document.getElementById('data_inicio');
        const inputFim = document.getElementById('data_fim');

        function gerenciarBloqueio() {
            // Se houver data no campo "Dia Específico"
            if (inputUnico.value !== "") {
                inputInicio.disabled = true;
                inputFim.disabled = true;
                inputInicio.style.opacity = "0.5";
                inputFim.style.opacity = "0.5";
            } 
            // Se houver data em qualquer campo do "Intervalo"
            else if (inputInicio.value !== "" || inputFim.value !== "") {
                inputUnico.disabled = true;
                inputUnico.style.opacity = "0.5";
            } 
            // Se tudo estiver vazio, libera todos os campos
            else {
                inputUnico.disabled = false;
                inputInicio.disabled = false;
                inputFim.disabled = false;
                inputUnico.style.opacity = "1";
                inputInicio.style.opacity = "1";
                inputFim.style.opacity = "1";
            }
        }

        // Executa ao carregar para manter consistência em filtros já aplicados
        gerenciarBloqueio();

        // Adiciona os ouvintes de evento para mudanças nos campos
        inputUnico.addEventListener('input', gerenciarBloqueio);
        inputInicio.addEventListener('input', gerenciarBloqueio);
        inputFim.addEventListener('input', gerenciarBloqueio);
    });
</script>

{% endblock %}